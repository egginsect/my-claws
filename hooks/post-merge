#!/bin/sh
# post-merge: Decrypt configuration and workspace files
# Supports multiple agent directories (e.g., coder, assistant)

set -e

# Ensure PATH includes common locations for Homebrew/1Password
export PATH="$PATH:/opt/homebrew/bin:/usr/local/bin"

# Exit if not a merge commit where ORIG_HEAD is available
if ! git rev-parse --verify --quiet ORIG_HEAD > /dev/null 2>&1; then
    echo "Info: Not a merge commit, skipping post-merge decryption."
    exit 0
fi

# Use secure key location (user's home directory or environment variable)
# 1. Try environment variable
if [ -n "$SOPS_AGE_KEY" ]; then
    echo "ðŸ”‘ Using SOPS key from environment variable"
    export SOPS_AGE_KEY="$SOPS_AGE_KEY"
# 2. Try 1Password
elif command -v op >/dev/null 2>&1; then
    # Check if signed in, if not prompt for sign-in
    if ! op whoami >/dev/null 2>&1; then
        echo "ðŸ” 1Password sign-in required for SOPS decryption"
        if ! op signin; then
            echo "âš ï¸  1Password sign-in failed, trying fallback methods..."
        fi
    fi

    # Try to fetch the key from 1Password
    if op whoami >/dev/null 2>&1; then
        echo "ðŸ”‘ Fetching SOPS key from 1Password..."
        if key=$(op read "op://Develop/openclaw-sops-key/password" 2>/dev/null); then
            export SOPS_AGE_KEY="$key"
        else
            echo "âš ï¸  Could not retrieve key from 1Password (item may not exist)"
            echo "   Trying fallback methods..."
        fi
    fi
fi

# 3. Fallback to local key file (if 1Password failed or unavailable)
if [ -z "$SOPS_AGE_KEY" ]; then
    if [ -n "$SOPS_AGE_KEY_FILE" ] && [ -f "$SOPS_AGE_KEY_FILE" ]; then
        echo "ðŸ”‘ Using SOPS key from file: $SOPS_AGE_KEY_FILE"
        export SOPS_AGE_KEY_FILE="$SOPS_AGE_KEY_FILE"
    elif [ -f "$HOME/.config/sops/age/keys.txt" ]; then
        echo "ðŸ”‘ Using SOPS key from: $HOME/.config/sops/age/keys.txt"
        export SOPS_AGE_KEY_FILE="$HOME/.config/sops/age/keys.txt"
    elif [ -f "key.txt" ]; then
        echo "ðŸ”‘ Using local key.txt"
        export SOPS_AGE_KEY_FILE="key.txt"
    else
        echo "âŒ No SOPS key found!"
        echo "   Please either:"
        echo "   1. Sign in to 1Password and ensure 'openclaw-sops-key' exists in 'Develop' vault"
        echo "   2. Set SOPS_AGE_KEY environment variable"
        echo "   3. Set SOPS_AGE_KEY_FILE to point to your key file"
        exit 1
    fi
fi

files_changed=$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD)

# Setup cleanup trap for temporary files
cleanup_temp_files() {
    rm -f /tmp/sops-merge-*.tmp 2>/dev/null || true
}
trap cleanup_temp_files EXIT

# 1. Decrypt openclaw.json
echo "$files_changed" | grep "\.openclaw/openclaw\.enc\.json$" | while read -r enc_file; do
    # Skip if encrypted file no longer exists (deleted)
    [ -f "$enc_file" ] || continue
    
    dec_file="${enc_file%.enc.json}.json"
    
    # Security: Remove target file if it's a symlink
    if [ -L "$dec_file" ]; then
        echo "âš ï¸  Warning: Removing symlink at $dec_file for security"
        rm "$dec_file"
    fi

    # Native Merge Logic
    if [ -f "$dec_file" ]; then
        # Create temp files for 3-way merge with unique names in /tmp
        temp_prefix="/tmp/sops-merge-$$-$(date +%s)"
        base_enc="${temp_prefix}.base.enc"
        base_dec="${temp_prefix}.base.tmp"
        remote_dec="${temp_prefix}.remote.tmp"

        # Security: Remove temp files if they exist as symlinks
        for temp_file in "$base_enc" "$base_dec" "$remote_dec"; do
            if [ -L "$temp_file" ]; then
                echo "âš ï¸  Warning: Removing symlink at $temp_file for security"
                rm "$temp_file"
            fi
        done

        # Try to get base version
        has_base=false
        if git show ORIG_HEAD:"$enc_file" > "$base_enc" 2>/dev/null; then
             if sops -d "$base_enc" > "$base_dec" 2>/dev/null; then
                has_base=true
             fi
        fi
        
        # Decrypt incoming (remote) version
        if sops -d "$enc_file" > "$remote_dec" 2>/dev/null; then
            if [ "$has_base" = "true" ]; then
                echo "ðŸ”„ Merging updates into $dec_file..."
                # git merge-file <current> <base> <other>
                if git merge-file -L "current" -L "base" -L "incoming" "$dec_file" "$base_dec" "$remote_dec"; then
                    echo "âœ… Merged $dec_file (clean)"
                else
                    echo "âš ï¸  CONFLICT in $dec_file. Conflict markers inserted."
                fi
            else
                # No base found (new file?), treat as 2-way merge or overwrite?
                # If we have local file but no base, it's a collision.
                # Let's try merge-file with empty base? 
                # Or just warn and overwrite/backup? 
                # Git merge-file without base effectively does a 2-way diff.
                echo "ðŸ”„ Merging new file into local $dec_file..."
                if git merge-file -L "current" -L "empty base" -L "incoming" "$dec_file" /dev/null "$remote_dec"; then
                     echo "âœ… Merged $dec_file (clean)"
                else
                     echo "âš ï¸  CONFLICT in $dec_file. Conflict markers inserted."
                fi
            fi
        else
            echo "âŒ Error: Failed to decrypt incoming $enc_file"
        fi
        
        # Cleanup temp files immediately
        rm -f "$base_enc" "$base_dec" "$remote_dec" 2>/dev/null || true
    else
        # No local file, just decrypt
        echo "ðŸ”“ SOPS: Decrypting $dec_file..."
        sops -d "$enc_file" > "$dec_file"
    fi
done

# 2. Decrypt Workspace MD files
echo "$files_changed" | grep "\.openclaw/workspace/.*\.enc\.md$" | grep -v "\.enc\.enc\.md$" | while read -r enc_file; do
    # Skip if encrypted file no longer exists (deleted)
    [ -f "$enc_file" ] || continue

    dec_file="${enc_file%.enc.md}.md"
    
    # Security: Remove target file if it's a symlink
    if [ -L "$dec_file" ]; then
        echo "âš ï¸  Warning: Removing symlink at $dec_file for security"
        rm "$dec_file"
    fi

    # Native Merge Logic
    if [ -f "$dec_file" ]; then
        # Create temp files for 3-way merge with unique names in /tmp
        temp_prefix="/tmp/sops-merge-$$-$(date +%s)"
        base_enc="${temp_prefix}.base.enc"
        base_dec="${temp_prefix}.base.tmp"
        remote_dec="${temp_prefix}.remote.tmp"

        # Security: Remove temp files if they exist as symlinks
        for temp_file in "$base_enc" "$base_dec" "$remote_dec"; do
            if [ -L "$temp_file" ]; then
                echo "âš ï¸  Warning: Removing symlink at $temp_file for security"
                rm "$temp_file"
            fi
        done

        # Try to get base version
        has_base=false
        if git show ORIG_HEAD:"$enc_file" > "$base_enc" 2>/dev/null; then
             if sops -d "$base_enc" > "$base_dec" 2>/dev/null; then
                has_base=true
             fi
        fi
        
        # Decrypt incoming (remote) version
        if sops -d "$enc_file" > "$remote_dec" 2>/dev/null; then
            if [ "$has_base" = "true" ]; then
                echo "ðŸ”„ Merging updates into $dec_file..."
                # git merge-file <current> <base> <other>
                if git merge-file -L "current" -L "base" -L "incoming" "$dec_file" "$base_dec" "$remote_dec"; then
                    echo "âœ… Merged $dec_file (clean)"
                else
                    echo "âš ï¸  CONFLICT in $dec_file. Conflict markers inserted."
                fi
            else
                echo "ðŸ”„ Merging new file into local $dec_file..."
                if git merge-file -L "current" -L "empty base" -L "incoming" "$dec_file" /dev/null "$remote_dec"; then
                     echo "âœ… Merged $dec_file (clean)"
                else
                     echo "âš ï¸  CONFLICT in $dec_file. Conflict markers inserted."
                fi
            fi
        else
            echo "âŒ Error: Failed to decrypt incoming $enc_file"
        fi
        
        # Cleanup temp files immediately
        rm -f "$base_enc" "$base_dec" "$remote_dec" 2>/dev/null || true
    else
        # No local file, just decrypt
        echo "ðŸ”“ SOPS: Decrypting $dec_file..."
        sops -d "$enc_file" > "$dec_file"
    fi
done

echo "âœ… SOPS: Decryption complete."

#!/bin/sh
# pre-commit: Encrypt openclaw.json and workspace MD files
# Supports multiple agent directories (e.g., coder, assistant)

export SOPS_AGE_KEY_FILE=key.txt

# Find all .openclaw directories to identify agents
find . -type d -name ".openclaw" -not -path "*/node_modules/*" | while read -r openclaw_dir; do
    # 1. Encrypt openclaw.json
    config_file="$openclaw_dir/openclaw.json"
    if [ -f "$config_file" ]; then
        echo "ðŸ”’ SOPS: Encrypting configuration in $config_file..."
        enc_file="${config_file%.json}.enc.json"
        sops -e "$config_file" > "$enc_file"
        git add "$enc_file"
    fi

    # 2. Encrypt Workspace MD files (maxdepth 1 only)
    workspace_dir="$openclaw_dir/workspace"
    if [ -d "$workspace_dir" ]; then
        find "$workspace_dir" -maxdepth 1 -name "*.md" -not -name "*.enc.md" | while read -r file; do
            echo "ðŸ”’ SOPS: Encrypting workspace file $file..."
            enc_file="${file%.md}.enc.md"
            sops -e "$file" > "$enc_file"
            git add "$enc_file"
        done
    fi
done

echo "âœ… SOPS: Encryption complete."

#!/bin/sh
# pre-commit: Encrypt openclaw.json and workspace MD files
# Supports multiple agent directories (e.g., coder, assistant)

set -e

# Ensure PATH includes common locations for Homebrew/1Password
export PATH="$PATH:/opt/homebrew/bin:/usr/local/bin"

# Use secure key location (user's home directory or environment variable)
# 1. Try environment variable
if [ -n "$SOPS_AGE_KEY" ]; then
    echo "ðŸ”‘ Using SOPS key from environment variable"
    export SOPS_AGE_KEY="$SOPS_AGE_KEY"
# 2. Try 1Password
elif command -v op >/dev/null 2>&1; then
    # Check if signed in, if not prompt for sign-in
    if ! op whoami >/dev/null 2>&1; then
        echo "ðŸ” 1Password sign-in required for SOPS encryption"
        if ! op signin; then
            echo "âš ï¸  1Password sign-in failed, trying fallback methods..."
        fi
    fi

    # Try to fetch the key from 1Password
    if op whoami >/dev/null 2>&1; then
        echo "ðŸ”‘ Fetching SOPS key from 1Password..."
        if key=$(op read "op://Develop/openclaw-sops-key/password" 2>/dev/null); then
            export SOPS_AGE_KEY="$key"
        else
            echo "âš ï¸  Could not retrieve key from 1Password (item may not exist)"
            echo "   Trying fallback methods..."
        fi
    fi
fi

# 3. Fallback to local key file (if 1Password failed or unavailable)
if [ -z "$SOPS_AGE_KEY" ]; then
    if [ -n "$SOPS_AGE_KEY_FILE" ] && [ -f "$SOPS_AGE_KEY_FILE" ]; then
        echo "ðŸ”‘ Using SOPS key from file: $SOPS_AGE_KEY_FILE"
        export SOPS_AGE_KEY_FILE="$SOPS_AGE_KEY_FILE"
    elif [ -f "$HOME/.config/sops/age/keys.txt" ]; then
        echo "ðŸ”‘ Using SOPS key from: $HOME/.config/sops/age/keys.txt"
        export SOPS_AGE_KEY_FILE="$HOME/.config/sops/age/keys.txt"
    elif [ -f "key.txt" ]; then
        echo "ðŸ”‘ Using local key.txt"
        export SOPS_AGE_KEY_FILE="key.txt"
    else
        echo "âŒ No SOPS key found!"
        echo "   Please either:"
        echo "   1. Sign in to 1Password and ensure 'openclaw-sops-key' exists in 'Develop' vault"
        echo "   2. Set SOPS_AGE_KEY environment variable"
        echo "   3. Set SOPS_AGE_KEY_FILE to point to your key file"
        exit 1
    fi
fi

# Find all .openclaw directories to identify agents
find . -type d -name ".openclaw" -not -path "*/node_modules/*" | while read -r openclaw_dir; do
    # 1. Encrypt openclaw.json (only if changed)
    config_file="$openclaw_dir/openclaw.json"
    if [ -f "$config_file" ]; then
        enc_file="${config_file%.json}.enc.json"
        # Only encrypt if source is newer or encrypted file doesn't exist
        if [ ! -f "$enc_file" ] || [ "$config_file" -nt "$enc_file" ]; then
            # Security: Check target is not a symlink before writing
            if [ -L "$enc_file" ]; then
                echo "âŒ Error: Refusing to overwrite symlink at $enc_file"
                exit 1
            fi
            echo "ðŸ”’ SOPS: Encrypting configuration in $config_file..."
            sops -e "$config_file" > "$enc_file"
            git add "$enc_file"
        fi
    fi

    # 2. Encrypt Workspace MD files (maxdepth 1 only, only if changed)
    workspace_dir="$openclaw_dir/workspace"
    if [ -d "$workspace_dir" ]; then
        find "$workspace_dir" -maxdepth 1 -name "*.md" -not -name "*.enc.md" | while read -r file; do
            enc_file="${file%.md}.enc.md"
            # Only encrypt if source is newer or encrypted file doesn't exist
            if [ ! -f "$enc_file" ] || [ "$file" -nt "$enc_file" ]; then
                # Security: Check target is not a symlink before writing
                if [ -L "$enc_file" ]; then
                    echo "âŒ Error: Refusing to overwrite symlink at $enc_file"
                    exit 1
                fi
                echo "ðŸ”’ SOPS: Encrypting workspace file $file..."
                sops -e "$file" > "$enc_file"
                git add "$enc_file"
            fi
        done
    fi
done

echo "âœ… SOPS: Encryption complete."
